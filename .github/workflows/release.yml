name: å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: true
        type: string
      release_notes:
        description: 'ç‰ˆæœ¬æ›´æ–°è¯´æ˜'
        required: false
        type: string
        default: ''

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config --local user.email "kindom162@gmail.com"
          git config --local user.name "ispace"

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # æ›´æ–° version.py
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" app/version.py

          # éªŒè¯ä¿®æ”¹
          echo "æ›´æ–°åçš„ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          grep "__version__" app/version.py

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          VERSION="${{ github.event.inputs.version }}"

          git add app/version.py
          git commit -m "chore: å‘å¸ƒç‰ˆæœ¬ $VERSION"
          git push origin main

      - name: åˆ›å»º Git Tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬"
            CHANGELOG="## é¦–æ¬¡å‘å¸ƒ\n\n${{ github.event.inputs.release_notes }}"
          else
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_TAG"

            # ç”Ÿæˆæäº¤æ—¥å¿—
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)

            CHANGELOG="## æ›´æ–°å†…å®¹\n\n"
            if [ -n "${{ github.event.inputs.release_notes }}" ]; then
              CHANGELOG="${CHANGELOG}${{ github.event.inputs.release_notes }}\n\n"
            fi
            CHANGELOG="${CHANGELOG}### æäº¤è®°å½•\n\n${COMMITS}"
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo -e "$CHANGELOG" > changelog.md

          # è¾“å‡ºç”¨äº GitHub Release
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: Release v${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… ç‰ˆæœ¬ v${{ github.event.inputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
