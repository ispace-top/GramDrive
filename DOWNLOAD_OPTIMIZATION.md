# 大文件下载问题优化说明

## 已实施的优化

### 1. 增加 HTTP 客户端超时时间

**文件**: `app/core/http_client.py`

**修改内容**:
- 连接超时: 30秒
- **读取超时: 3600秒（60分钟）** ⬅️ 关键改动
- 写入超时: 300秒（5分钟）
- 连接池超时: 10秒

**原因**:
- 原来的 300秒（5分钟）超时对 2GB 文件不够
- 2GB 文件需要至少 6.8MB/s 的下载速度才能在5分钟内完成
- 实际网络环境中，Telegram CDN 速度可能在 1-5 MB/s 之间波动
- 新的 60分钟超时支持 0.57 MB/s 的慢速下载

### 2. 改进下载服务日志

**文件**: `app/services/download_service.py`

**新增功能**:
- ✅ 下载开始时记录文件大小和 URL
- ✅ 实时显示下载进度（百分比、已下载/总大小、速度）
- ✅ 下载完成后统计总耗时、平均速度、总块数
- ✅ 详细的错误分类（超时、HTTP错误、其他异常）
- ✅ 超时错误显示已下载量和耗时
- ✅ HTTP 错误显示状态码

**日志示例**:
```
[INFO] 【下载服务】开始下载文件: movie.mp4，大小: 2048.00MB，URL: https://api.telegram.org/file/bot...
[INFO] 【下载服务】服务器返回文件大小: 2048.00MB
[DEBUG] 【下载服务】下载进度: movie.mp4 - 25.5% (522.24MB / 2048.00MB) 速度: 2.15MB/s
[DEBUG] 【下载服务】下载进度: movie.mp4 - 51.2% (1048.58MB / 2048.00MB) 速度: 2.08MB/s
[INFO] 【下载服务】文件下载完成: movie.mp4，耗时: 982.3秒，平均速度: 2.09MB/s，总块数: 65536
```

**错误日志示例**:
```
[ERROR] 【下载服务】下载超时: movie.mp4，已下载: 1024.50MB / 2048.00MB，耗时: 3600.2秒，错误: Read timeout
[ERROR] 【下载服务】HTTP错误: movie.mp4，状态码: 403，错误: Forbidden
[ERROR] 【下载服务】下载异常: movie.mp4，已下载: 256.30MB，耗时: 128.5秒，错误类型: ConnectionError，详情: Connection reset by peer
```

## 如何查看日志

### Docker 容器日志

```bash
# 实时查看日志
docker logs -f gramdrive

# 查看最近 500 行日志
docker logs --tail 500 gramdrive

# 查看并搜索下载相关日志
docker logs gramdrive 2>&1 | grep "下载服务"

# 查看错误日志
docker logs gramdrive 2>&1 | grep -i error
```

### 日志文件位置

如果配置了日志文件输出，默认位置:
- 容器内: `/app/logs/app.log`
- 挂载到主机: `./logs/app.log`（如果有挂载）

## 常见问题排查

### 1. 下载仍然超时

**症状**: 日志显示 "下载超时"

**可能原因**:
- 网络速度太慢（< 0.5 MB/s）
- Telegram CDN 限速
- 服务器带宽不足

**解决方案**:
```bash
# 临时测试：手动下载文件检查速度
# 在容器内执行
docker exec gramdrive wget -O /tmp/test.mp4 "下载URL" --timeout=3600

# 检查下载速度
# 如果速度正常，可能是代码问题；如果速度慢，是网络问题
```

### 2. 内存不足

**症状**: 日志显示 "MemoryError" 或容器被 OOM Killer 杀死

**解决方案**:
```bash
# 增加 Docker 容器内存限制
docker run -d --name gramdrive \
  -p 8000:8000 \
  -v ./data:/app/data \
  -v ./downloads:/app/downloads \
  --memory=2g \  # 增加到 2GB
  ispacetop/gramdrive:latest
```

### 3. 磁盘空间不足

**症状**: 日志显示 "No space left on device"

**检查方法**:
```bash
# 检查磁盘空间
df -h

# 检查下载目录空间
du -sh ./downloads

# 清理空间（如有需要）
docker system prune -a
```

### 4. 文件下载到一半失败

**症状**: 日志显示已下载部分数据后失败

**可能原因**:
- 网络中断
- Telegram URL 过期（通常24小时有效）
- 下载服务重启

**当前行为**:
- 失败的文件会标记为错误状态
- 支持自动重试（指数退避）
- 不支持断点续传（下次会重新下载）

**未来改进方向**:
- 实现断点续传功能
- 分块下载大文件

### 5. 下载速度慢

**可能原因**:
- Telegram CDN 服务器位置远
- 本地网络带宽限制
- 服务器 CPU/IO 性能限制

**优化建议**:
```bash
# 1. 减少并发下载数（降低资源竞争）
# 在下载管理页面设置：线程数 = 1 或 2

# 2. 使用更好的网络环境
# 如果可能，将服务器部署在靠近 Telegram CDN 的地区

# 3. 检查系统资源
docker stats gramdrive
```

## 测试建议

### 测试 2GB 文件下载

1. **准备测试文件**:
   - 上传一个 2GB 左右的视频到 Telegram 频道
   - 确保已在下载设置中启用自动下载

2. **监控日志**:
   ```bash
   # 在一个终端实时查看日志
   docker logs -f gramdrive | grep "下载服务"
   ```

3. **观察指标**:
   - 下载开始时间
   - 每秒更新的进度和速度
   - 总耗时
   - 是否有错误

4. **预期结果**:
   - 2GB @ 2 MB/s = 约 17 分钟
   - 2GB @ 1 MB/s = 约 34 分钟
   - 2GB @ 0.5 MB/s = 约 68 分钟（仍在60分钟超时内需更快网络）

### 压力测试

```bash
# 同时下载多个大文件，观察系统表现
# 在下载管理中上传多个 500MB-1GB 的文件

# 监控系统资源
docker stats gramdrive

# 查看内存使用
# 应该保持稳定，不会持续增长（有内存泄漏）
```

## 性能基准

| 文件大小 | 网速 1MB/s | 网速 2MB/s | 网速 5MB/s |
|---------|-----------|-----------|-----------|
| 500MB   | 8 分钟     | 4 分钟     | 2 分钟     |
| 1GB     | 17 分钟    | 8 分钟     | 3 分钟     |
| 2GB     | 34 分钟    | 17 分钟    | 7 分钟     |
| 4GB     | 68 分钟 ⚠️  | 34 分钟    | 14 分钟    |

⚠️ 注意：4GB 文件在 1MB/s 网速下会超过60分钟超时限制

## 需要进一步优化的方向

如果问题仍然存在，可以考虑以下改进：

1. **实现断点续传**
   - 记录已下载的字节位置
   - 使用 HTTP Range 请求继续下载
   - 失败后不需要重新开始

2. **分块下载**
   - 将大文件分成多个小块
   - 并行下载多个块
   - 失败只需重试单个块

3. **动态超时**
   - 根据文件大小自动计算超时时间
   - 根据当前速度动态调整

4. **下载队列优化**
   - 大文件优先级
   - 智能重试策略
   - 失败文件自动降级（跳过）

## 总结

当前优化主要解决了超时问题：
- ✅ HTTP 读取超时从 5分钟 增加到 60分钟
- ✅ 添加详细的下载日志便于排查问题
- ✅ 改进错误处理和分类

**建议操作**：
1. 重新构建并部署新版本
2. 测试 2GB 视频下载
3. 实时监控日志查看详细信息
4. 如果仍然失败，根据日志错误信息进一步诊断

**查看日志命令**：
```bash
docker logs -f gramdrive 2>&1 | grep -E "下载服务|ERROR"
```
