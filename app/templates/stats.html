{% extends "base.html" %}

{% block title %}æ•°æ®ç»Ÿè®¡ - Gram Drive{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>æ•°æ®ç»Ÿè®¡</h1>
        <p class="text-muted">æŸ¥çœ‹å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µå’Œæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯</p>
    </div>

    <div id="statsLoading" class="card" style="text-align: center; padding: 40px;">
        <div style="margin-bottom: 16px;">åŠ è½½ä¸­...</div>
    </div>

    <div id="statsContent" style="display: none;">
        <!-- æ•°æ®æºåˆ‡æ¢ -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <span class="text-muted" style="font-size: 14px;">ç»Ÿè®¡èŒƒå›´:</span>
            <div class="stats-toggle-group" style="display: flex; background: var(--hover-bg); border-radius: 8px; padding: 4px;">
                <button class="stats-toggle-btn active" data-source="cloud" style="padding: 8px 16px; font-size: 14px; border: none; background: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">äº‘ç«¯æ–‡ä»¶</button>
                <button class="stats-toggle-btn" data-source="local" style="padding: 8px 16px; font-size: 14px; border: none; background: transparent; color: var(--text-muted); border-radius: 6px; cursor: pointer; transition: all 0.2s;">æœ¬åœ°å·²ä¸‹è½½</button>
            </div>
        </div>

        <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                    <div class="stat-value" id="totalCount">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»å­˜å‚¨ç©ºé—´</div>
                    <div class="stat-value" id="totalSize">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»ä¸‹è½½æ¬¡æ•°</div>
                    <div class="stat-value" id="totalDownloads">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">å¹³å‡æ–‡ä»¶å¤§å°</div>
                    <div class="stat-value" id="avgSize">-</div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ç±»å‹åˆ†å¸ƒ -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">æ–‡ä»¶ç±»å‹åˆ†å¸ƒ</h2>
            </div>
            <div class="card-body">
                <div id="fileTypesList"></div>
            </div>
        </div>

        <!-- çƒ­é—¨æ–‡ä»¶ -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">çƒ­é—¨æ–‡ä»¶ (ä¸‹è½½æ¬¡æ•°æœ€å¤š)</h2>
            </div>
            <div class="card-body">
                <div id="popularFilesList"></div>
            </div>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon svg {
    width: 28px;
    height: 28px;
    stroke: white;
}

.stat-info {
    flex: 1;
}

.stat-label {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-color);
}

.file-type-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.file-type-item:last-child {
    border-bottom: none;
}

.file-type-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-size: 20px;
}

.file-type-info {
    flex: 1;
}

.file-type-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.file-type-stats {
    font-size: 13px;
    color: var(--text-muted);
}

.popular-file-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: var(--hover-bg);
    transition: background 0.2s;
}

.popular-file-item:hover {
    background: var(--border-color);
}

.popular-file-rank {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-right: 12px;
    flex-shrink: 0;
}

.popular-file-info {
    flex: 1;
    min-width: 0;
}

.popular-file-name {
    font-weight: 600;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.popular-file-meta {
    font-size: 13px;
    color: var(--text-muted);
}

.popular-file-downloads {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 18px;
}
</style>

<script>
let statsData = null;
let currentSource = 'cloud'; // 'cloud' or 'local'

async function loadStats() {
    try {
        const response = await fetch('/api/stats/dashboard');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();

        if (!result || result.status !== 'success' || !result.data) {
            throw new Error('Invalid response format');
        }

        statsData = result.data;
        renderStats();

        // æ˜¾ç¤ºå†…å®¹
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';

    } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';

        document.getElementById('totalCount').textContent = '0';
        document.getElementById('totalSize').textContent = '0 B';
        document.getElementById('totalDownloads').textContent = '0';
        document.getElementById('avgSize').textContent = '0 B';
        document.getElementById('fileTypesList').innerHTML = '<p class="text-muted">æš‚æ— æ•°æ®</p>';
        document.getElementById('popularFilesList').innerHTML = '<p class="text-muted">æš‚æ— æ•°æ®</p>';
    }
}

function renderStats() {
    if (!statsData) return;

    const isLocal = currentSource === 'local';

    // é€‰æ‹©å¯¹åº”æ•°æ®
    const count = isLocal ? (statsData.local_files_count || 0) : (statsData.total_count || 0);
    const size = isLocal ? (statsData.local_files_size || 0) : (statsData.total_size || 0);
    const sizeFormatted = isLocal ? (statsData.local_files_size_formatted || '0 B') : (statsData.total_size_formatted || '0 B');
    const fileTypes = isLocal ? (statsData.local_file_types || []) : (statsData.file_types || []);

    // è®¡ç®—å¹³å‡å¤§å°
    const avgSize = count > 0 ? size / count : 0;
    const avgSizeFormatted = formatSize(avgSize);

    // æ›´æ–°æ€»ä½“ç»Ÿè®¡
    document.getElementById('totalCount').textContent = count.toLocaleString();
    document.getElementById('totalSize').textContent = sizeFormatted;
    document.getElementById('totalDownloads').textContent = (statsData.total_downloads || 0).toLocaleString();
    document.getElementById('avgSize').textContent = avgSizeFormatted;

    // æ–‡ä»¶ç±»å‹åˆ†å¸ƒ
    const icons = {
        'image': 'ğŸ–¼ï¸',
        'video': 'ğŸ¬',
        'audio': 'ğŸµ',
        'document': 'ğŸ“„',
        'archive': 'ğŸ“¦',
        'pdf': 'ğŸ“‘',
        'text': 'ğŸ“',
        'other': 'ğŸ“'
    };

    const colors = {
        'image': '#667eea',
        'video': '#f093fb',
        'audio': '#4facfe',
        'document': '#fa709a',
        'archive': '#f6d365',
        'pdf': '#ff6b6b',
        'text': '#51cf66',
        'other': '#a8edea'
    };

    const fileTypesHtml = fileTypes.map(type => `
        <div class="file-type-item">
            <div class="file-type-icon" style="background: ${colors[type.type] || colors.other}33;">
                ${icons[type.type] || icons.other}
            </div>
            <div class="file-type-info">
                <div class="file-type-name">${type.type_label}</div>
                <div class="file-type-stats">${type.count} ä¸ªæ–‡ä»¶ Â· ${type.size_formatted}</div>
            </div>
        </div>
    `).join('');

    document.getElementById('fileTypesList').innerHTML = fileTypesHtml || '<p class="text-muted">æš‚æ— æ•°æ®</p>';

    // çƒ­é—¨æ–‡ä»¶ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œä¸åŒºåˆ† local/cloudï¼‰
    const popularFilesHtml = ((statsData.popular_files || []).slice(0, 10)).map((file, index) => `
        <div class="popular-file-item">
            <div class="popular-file-rank" style="background: ${index < 3 ? '#f5576c' : '#667eea'}">
                ${index + 1}
            </div>
            <div class="popular-file-info">
                <div class="popular-file-name" title="${file.filename}">${file.filename}</div>
                <div class="popular-file-meta">${file.filesize_formatted}</div>
            </div>
            <div class="popular-file-downloads">${file.download_count}</div>
        </div>
    `).join('');

    document.getElementById('popularFilesList').innerHTML = popularFilesHtml || '<p class="text-muted">æš‚æ— æ•°æ®</p>';
}

function formatSize(sizeInBytes) {
    if (sizeInBytes == null || sizeInBytes === 0) return '0 B';
    if (sizeInBytes < 1024) return `${sizeInBytes} B`;
    let size = sizeInBytes;
    for (const unit of ['B', 'KB', 'MB', 'GB', 'TB']) {
        if (size < 1024.0) return `${size.toFixed(2)} ${unit}`;
        size /= 1024.0;
    }
    return `${size.toFixed(2)} PB`;
}

// åˆ‡æ¢æŒ‰é’®äº‹ä»¶
document.addEventListener('click', (e) => {
    const btn = e.target.closest('.stats-toggle-btn');
    if (!btn) return;

    const source = btn.dataset.source;
    if (source === currentSource) return;

    currentSource = source;

    // æ›´æ–°æŒ‰é’®æ ·å¼
    document.querySelectorAll('.stats-toggle-btn').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = 'var(--text-muted)';
    });
    btn.classList.add('active');
    btn.style.background = 'var(--primary-color)';
    btn.style.color = 'white';

    // é‡æ–°æ¸²æŸ“
    renderStats();
});

// é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
loadStats();
</script>
{% endblock %}
